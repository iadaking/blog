---
typora-copy-images-to: ..\img
---

[TOC]
# 第2章 Java内存区域与内存溢出异常

## 2.1 概述

Java程序员不用再为内存管理而烦恼，但是将内存控制权利交给Java虚拟机来管理，一但出现内存泄漏方面的问题，如果不了解虚拟机是怎样使用内存的，那么排查工作将十分的艰难。

## 2.2 运行时数据区域

随着虚拟机进程的启动而存在，由所有线程共享的数据区域

- 方法区
- 堆

以下区域随着用户线程的启动和结束而建立和销毁，线程隔离的数据区域

- 程序计数器
- 虚拟机栈
- 本地方法栈

### 2.2.1 程序计数器

每个线程都有一个独立的线程计数器，这块内存称为线程私有的内存区域。

程序计数器内存区域是唯一一个在Java虚拟机规范中没有规定任何OutOfMemoryError情况的区域。

### 2.2.2 Java虚拟机栈

Java虚拟机栈是线程私有的区域，他的生命周期与线程相同。Java虚拟机栈的栈帧用于存储局部变量表、操作数栈、动态链接、方法出口等信息。

局部变量表存放了编译期可知的各种基本数据类型（boolean、char、byte、short、int、long、float、double）、对象引用、returnAddress类型。

如果线程请求的栈深度大于虚拟机所允许的深度时，将抛出StackOverflowError异常。当虚拟机栈动态扩展时，若无法申请到足够的内存，就会抛出OutOfMemoryError异常。

### 2.2.3 本地方法栈

虚拟机栈为虚拟机执行Java方法服务，本地方法栈则为虚拟机使用到的Native方法服务。本地方法栈区域也会抛出`StackOverflowError`和`OutOfMemoryError`异常。

### 2.2.4 Java堆

内存区域最大，Java堆是被所有线程共享的一块内存区域，虚拟机启动时创建，此内存区域用来存放对象实例。

Java堆是垃圾收集器管理的主要区域，可以细分为：新生代和老年代。

Java堆只需要逻辑上连续即可，物理上可以处于不连续的内存空间中。Java堆大小的扩展可以通过 `-Xmx` 和 `-Xms` 控制。如果堆中没有内存完成实例分配，并且也无法再扩展时，将会抛出 `OutOfMemoryError` 异常。

### 2.2.5 方法区

方法区和堆一样都是线程共享的内存区域，方法区存储了已被虚拟机加载的类信息、常量、静态变量、即时编译器编译后的代码等数据。当方法区无法满足内存分配需求时，将抛出 OutOfMemoryError 异常。

### 2.2.6 运行时常量池

运行时常量池是方法区的一部分， Class 文件中有一项常量池，用于存放编译期生成的各种字面量和符号引用，该内容在类加载后进入方法区运行时常量池中存放。

一般来说，Class 文件中描述的符号引用和翻译出来的直接引用也会存在运行时常量池中。

运行时常量池具备动态性，运行期间也可能将新的常量放入池中，这种特性的被利用的较多便是 String 类的 intern() 方法。

当常量池无法申请到内存时会抛出 OutOfMemoryError 异常。

### 2.2.7 直接内存

直接内存也会被频繁的使用，也有可能导致 OutOfMemoryError 异常出现。

Java 1.4 新加入了 NIO 类，基于通道和缓冲区的 I/O 方式，可以使用 Native 函数库直接分配堆外内存，忽略直接内存时也会导致动态拓展时出现 OutOfMemoryError 异常。

##  2.3 HotSpot 虚拟机对象探秘

### 2.3.1 对象的创建

为对象分配堆内存空间的方式有，指针碰撞和空闲列表。

虚拟机采用 CAS 配上失败重试的方式保证分配内存空间动作的原子性。另一种内存分配动作称为本地线程分配缓冲。

通过 -XX:+/-UseTLAB 参数，可以设定是否使用本地线程分配缓冲。

### 2.3.2 对象的内存布局

对象在内存中的布局分为 3 块区域：

- 对象头
- 实例数据
- 对齐填充

#### 对象头

存储对象自身运行时数据，如哈希码、GC 分代年龄、锁状态标志、线程持有的锁、偏向线程 ID、偏向时间戳。

虚拟机通过类型指针确定一个对象属于哪个类的实例，另外查找对象的元数据信息并不一定要经过对象本身。

#### 实例数据

实例数据部分才是对象真正存储的有效信息，是程序代码中定义的各种类型的字段内容。

#### 对齐填充

对齐填充并不是必然存在的，它仅仅起着占位符的作用。

### 2.3.3 对象的访问定位

Java 程序需要通过**栈**上的 reference 数据来造作堆上的具体对象。

对象访问方式有句柄访问和直接指针两种，

## 2.4 实战：OutOfMemoryError 异常

在Java虚拟机规范的描述中，除了程序计数器外，虚拟机内存的其他几个运行时区域都有可能发生 OutOfMemoryError 异常。

### 2.4.1 Java 堆溢出

Java 堆用于存储对象实例，Java堆内存的OOM 异常时常见内存溢出情况。当Java堆内存溢出时，异常堆栈信息 `java.lang.OutOfMemoryError` 会跟着进一步提示 `Java heap space` 。

堆最小值参数 `-Xms` 堆最大值参数 `-Xmx` 。

### 2.4.2 虚拟机栈和本地方法栈溢出

在 HotSpot 虚拟机中栈容量只由 `-Xss` 参数设置。

在建立多线程导致内存溢出时，如果不能减少线程数或更换64位虚拟机，只能通过减少最大堆和减少栈容量来换取更多线程。